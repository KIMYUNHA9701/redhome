<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssangyong.redhome.dao.BoardMapper">



    <sql id ="search" >

        <if test="type == 'search_title'">
            quest_title like '%'||'${keyword}'||'%' and
        </if>
        <if test="type == 'search_contents'">
            quest_contents like '%'||'${keyword}'||'%' and
        </if>
        <if test="type == 'search_id'">
            member_id like '%'||'${keyword}'||'%' and
        </if>
    </sql>


    <select id="selectQuestion" resultType="com.ssangyong.redhome.bean.Quest" parameterType="Integer">
        SELECT QUEST_NUM,QUEST_TITLE,QUEST_CONTENTS,QUEST_IMG,QUEST_PWD, TO_CHAR(QUEST_DATE,'YYYY"년" MM"월" dd"일" HH24:MI') As QUEST_DATE,
               QUEST_STATE,QUEST_CATEGORY_NUM, MEMBER_ID
        FROM quest
        WHERE quest_num = #{VALUE}
    </select>


    <select id="selectAnswer" resultType="com.ssangyong.redhome.bean.Answer" parameterType="Integer">
        SELECT * FROM answer
        WHERE quest_num = #{VALUE}

    </select>



    <select id="selectTotalCnt" resultType="Integer" parameterType="java.util.HashMap">

        select count(*)total from quest
        <if test='type!=null or reply=="not_yet" or orderType =="newAnswer"'>where</if>

        <if  test='type!=null'>
            <choose>
                <when test="type == 'search_title'">
                    quest_title like '%'||'${keyword}'||'%'
                </when>
                <when test="type == 'search_contents'">
                    quest_contents like '%'||'${keyword}'||'%'
                </when>
                <otherwise>
                    member_id like '%'||'${keyword}'||'%'
                </otherwise>
            </choose>
        </if>

        <if test='type!=null and reply=="not_yet"'>and</if>

       <if test='reply=="not_yet"'>
           quest_state = '답변대기'

       </if>

        <if test='type!=null and orderType=="newAnswer"'>and</if>

        <if test='orderType=="newAnswer"'>

             quest_num in (
                select /*+ INDEX_DESC(answer answer_answer_num_idx) */ quest_num
                from answer
                where quest_num > 0)

        </if>


    </select>



    <select id="getBoardPaging" resultType="com.ssangyong.redhome.bean.Quest" parameterType="java.util.HashMap" >


        select quest_num, quest_title, quest_contents, quest_img, quest_pwd, quest_date, quest_state, quest_category_num, member_id
        from (
        select /*+ INDEX_DESC(quest PK_QUEST) */ rownum rn, quest_num, quest_title, quest_contents,
        quest_img, quest_pwd, quest_date, quest_state, quest_category_num, member_id
        from quest

        <where>
            <include refid="search"></include>
            <choose>
                <when test='reply=="not_yet"'>
                    <![CDATA[       quest_num>0 and quest_state = '답변대기' and rownum > 0 and rownum <= (${pageNum} * ${amount})  )  ]]>
                </when>
                <otherwise>
                    <![CDATA[       quest_num>0 and rownum > 0 and rownum <= (${pageNum} * ${amount}) ) ]]>

                </otherwise>
            </choose>


        </where>

        <![CDATA[    where rn >(${pageNum} - 1) * ${amount}]]>

    </select>

    <select id="getBoardPagingNewAnswer" resultType="com.ssangyong.redhome.bean.Quest" parameterType="java.util.HashMap" >

        select quest_num, quest_title, quest_contents, quest_img, quest_pwd, quest_date, quest_state, quest_category_num, member_id
        from (
        select /*+ INDEX_DESC(quest PK_QUEST) */ rownum rn, quest_num, quest_title, quest_contents,
        quest_img, quest_pwd, quest_date, quest_state, quest_category_num, member_id
        from quest
        where
        <include refid="search"></include>
        <![CDATA[    quest_num>0 and quest_state = '답변완료' and rownum > 0 and rownum <= (${pageNum} * ${amount})  )  ]]>

        where rn >(${pageNum} - 1) * ${amount} and quest_num in (
        select /*+ INDEX_DESC(answer answer_answer_num_idx) */ quest_num
        from answer
        where quest_num > 0)


    </select>


    <delete id="deleteBoard" parameterType="Integer" >

        delete from quest where quest_num = #{value}

    </delete>

    <select id="selectAllQna" resultType="com.ssangyong.redhome.bean.Quest" parameterType="java.util.Map">
        SELECT QUEST_NUM,QUEST_TITLE,QUEST_CONTENTS,QUEST_IMG,QUEST_PWD, TO_CHAR(QUEST_DATE,'YYYY"년" MM"월" dd"일" HH24:MI') As QUEST_DATE,
               QUEST_STATE,QUEST_CATEGORY_NUM, MEMBER_ID
        FROM quest
        <if test="query != null and data != null">
            WHERE ${query} LIKE '%'||#{data}||'%'
        </if>
        <if test="query2 != null">
            AND QUEST_STATE = ${query2}
        </if>
        ORDER BY QUEST_NUM
    </select>




</mapper>